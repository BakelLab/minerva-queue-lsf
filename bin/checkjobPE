#!/usr/bin/perl

# 20.04.2010 15:14:37 EDT
# Harm van Bakel <hvbakel@gmail.com>

# MODULES
use strict;
use warnings;
use Getopt::Long;

# GET PARAMETERS
my $sHelp        = 0;
GetOptions("help!"   => \$sHelp);

# PRINT HELP
if ($sHelp) {
   my $sScriptName = ($0 =~ /^.*\/(.+$)/) ? $1 : $0;
   die <<HELP

   Usage: $sScriptName

   Returns the total job 'processor equivalents' in use
   on the cluster.
       
    -help
      This help message
   
HELP
}


##########
## MAIN ##
##########

my $nPEsum;
open QSTAT, "/usr/bin/qstat -r |" or die "Error: can't query job queue: $!\n";
while (<QSTAT>){
   next if (/^\s*$/);
   next if (/^ *#/);
   s/[\n\r]+$//;
   my ($nID) = (split /\s+/)[0];
   if ($nID =~ /^\d+/){
      $nID =~ s/\..*$//;
      my $nPE = check_PE($nID);
      print "$nID\t$nPE\n";
      $nPEsum += $nPE;
   }
}
close QSTAT;
print "Total PE's: $nPEsum\n";

#################
## SUBROUTINES ##
#################


# check_PE
#
# 
sub check_PE {
   my ($nID) = @_;
   my $nPE   = 0;
   open CHK, "/opt/moab/bin/checkjob $nID|" or die "Error: can't run checkjob: $!\n";
      while (<CHK>){
         $nPE = $1 if (/^PE:\s+(\d+\.?\d*)/);
      }
   close CHK;
   return $nPE;
}

